#! /usr/bin/env bash

if [[ -z "${IN_GHOSTTY_FLOAT:-}" ]]; then
  export IN_GHOSTTY_FLOAT=1
  exec open-ghostty -f "$(realpath "$0")" "$@"
fi

# Get Image
tmp=$(mktemp)
yazi ~/Pictures/Wallpapers --chooser-file $tmp
image=$(cat $tmp)
rm -f $tmp

if [[ -f $image ]]; then
  theme=$(basename $(dirname "$image"))
  swww img "$image"
elif [[ -d "$image" ]]; then
  theme=$(basename "$image")
else
  exit
fi

# Get Mode
mode=$(cat ~/.local/share/user/theme-details | rg mode | awk '{print $2}')
[[ $mode != "light" ]] && mode="dark"

# Apply
if [[ $theme = 'Wallpapers' ]]; then
  theme="dynamic"
  matugen -q -c ~/.config/matugen/matugen.toml image "$image"
fi
matugen json ~/.config/matugen/themes/${theme}.json

# Save Image and Mode
echo "image: $image" >~/.local/share/user/theme-details
echo "mode: $mode" >>~/.local/share/user/theme-details
echo "theme: $theme" >>~/.local/share/user/theme-details
